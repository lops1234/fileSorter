<Window x:Class="FileTagger.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:tb="http://www.hardcodet.net/taskbar"
        Title="File Tagger" Height="600" Width="800"
        WindowStartupLocation="CenterScreen"
        StateChanged="Window_StateChanged"
        Closing="Window_Closing">
    <Grid>
        <!-- System Tray Icon -->
        <tb:TaskbarIcon x:Name="TrayIcon"
                        ToolTipText="File Tagger - Right click for options"
                        TrayMouseDoubleClick="TrayIcon_TrayMouseDoubleClick">
            <tb:TaskbarIcon.ContextMenu>
                <ContextMenu>
                    <MenuItem Header="Open Settings" Click="OpenSettings_Click"/>
                    <MenuItem Header="Manage Tags" Click="ManageTags_Click"/>
                    <Separator/>
                    <MenuItem Header="Exit" Click="Exit_Click"/>
                </ContextMenu>
            </tb:TaskbarIcon.ContextMenu>
        </tb:TaskbarIcon>

        <TabControl Margin="10">
            <!-- Settings Tab -->
            <TabItem Header="Settings">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Watched Directories" FontSize="16" FontWeight="Bold" Margin="0,0,0,10"/>

                    <Grid Grid.Row="1">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*"/>
                            <ColumnDefinition Width="Auto"/>
                        </Grid.ColumnDefinitions>

                        <ListBox x:Name="DirectoriesListBox" Grid.Column="0" 
                                 SelectionChanged="DirectoriesListBox_SelectionChanged"/>

                        <StackPanel Grid.Column="1" Width="120">
                            <Button x:Name="AddDirectoryButton" Content="Add Directory" Click="AddDirectory_Click"/>
                            <Button x:Name="RemoveDirectoryButton" Content="Remove Directory" Click="RemoveDirectory_Click" IsEnabled="False"/>
                            <Button x:Name="RefreshButton" Content="Refresh" Click="Refresh_Click" Margin="5,20,5,5"/>
                        </StackPanel>
                    </Grid>

                    <StackPanel Grid.Row="2" Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button x:Name="RefreshContextMenusButton" Content="Refresh Context Menus" Click="RefreshContextMenus_Click" Margin="0,0,10,0"/>
                        <Button x:Name="SaveSettingsButton" Content="Save Settings" Click="SaveSettings_Click"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- Tag Management Tab -->
            <TabItem Header="Tag Management">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Manage Tags" FontSize="16" FontWeight="Bold" Margin="0,0,0,10"/>

                    <StackPanel Grid.Row="1" Orientation="Horizontal">
                        <TextBox x:Name="NewTagTextBox" Width="200" Text="Enter new tag name" Foreground="Gray" GotFocus="TextBox_GotFocus" LostFocus="TextBox_LostFocus"/>
                        <TextBox x:Name="TagDescriptionTextBox" Width="300" Text="Tag description (optional)" Foreground="Gray" GotFocus="TextBox_GotFocus" LostFocus="TextBox_LostFocus"/>
                        <Button x:Name="CreateTagButton" Content="Create Tag" Click="CreateTag_Click"/>
                    </StackPanel>

                    <DataGrid Grid.Row="2" x:Name="TagsDataGrid" AutoGenerateColumns="False" 
                              CanUserAddRows="False" CanUserDeleteRows="False" 
                              SelectionMode="Single" Margin="0,10,0,10">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="Name" Binding="{Binding Name}" Width="200"/>
                            <DataGridTextColumn Header="Description" Binding="{Binding Description}" Width="300"/>
                            <DataGridTextColumn Header="Usage Count" Binding="{Binding TotalUsageCount}" Width="100"/>
                            <DataGridTextColumn Header="Source Directories" Binding="{Binding SourceDirectoriesString}" Width="300"/>
                        </DataGrid.Columns>
                    </DataGrid>

                    <StackPanel Grid.Row="3" Orientation="Horizontal" HorizontalAlignment="Right">
                        <Button x:Name="DeleteTagButton" Content="Delete Selected Tag" Click="DeleteTag_Click" IsEnabled="False"/>
                        <Button x:Name="RefreshTagsButton" Content="Refresh" Click="RefreshTags_Click"/>
                    </StackPanel>
                </Grid>
            </TabItem>

            <!-- File Browser Tab -->
            <TabItem Header="File Browser">
                <Grid Margin="10">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>

                    <TextBlock Grid.Row="0" Text="Browse Tagged Files" FontSize="16" FontWeight="Bold" Margin="0,0,0,10"/>

                                <StackPanel Grid.Row="1" Orientation="Vertical">
                <StackPanel Orientation="Horizontal" Margin="0,0,0,5">
                    <TextBlock Text="Advanced Tag Search:" VerticalAlignment="Center" Margin="0,0,10,0" FontWeight="Bold"/>
                    <TextBox x:Name="TagSearchTextBox" Width="300" 
                             Text="Enter search query..." Foreground="Gray" 
                             GotFocus="TagSearchTextBox_GotFocus" 
                             LostFocus="TagSearchTextBox_LostFocus"
                             KeyUp="TagSearchTextBox_KeyUp"/>
                    <Popup x:Name="TagSuggestionsPopup" 
                           PlacementTarget="{Binding ElementName=TagSearchTextBox}"
                           Placement="Bottom" 
                           IsOpen="False"
                           StaysOpen="False">
                        <Border Background="White" BorderBrush="Gray" BorderThickness="1" MaxHeight="200">
                            <ListBox x:Name="TagSuggestionsListBox" 
                                     MouseLeftButtonUp="TagSuggestion_Selected"
                                     KeyUp="TagSuggestionsListBox_KeyUp"/>
                        </Border>
                    </Popup>
                    <Button x:Name="SearchButton" Content="Search" Click="Search_Click" Margin="10,0,0,0"/>
                    <Button x:Name="ClearFilterButton" Content="Clear" Click="ClearFilter_Click" Margin="5,0,0,0"/>
                    <Button x:Name="RefreshAllTagsButton" Content="Refresh Tags" Click="RefreshAllTags_Click" Margin="5,0,0,0"/>
                    <Button x:Name="SearchHelpButton" Content="?" Click="SearchHelp_Click" Margin="5,0,0,0" Width="25" ToolTip="Show search syntax help"/>
                </StackPanel>
                <TextBlock x:Name="SearchStatusTextBlock" Margin="0,0,0,5" Foreground="Gray" FontSize="11"/>
                <TextBlock Text="Syntax: 'tag1 tag2' (AND), 'tag1 | tag2' (OR), '(tag1 | tag2) &amp; tag3' (grouping), '-tag' (exclude)" 
                           Margin="0,0,0,5" Foreground="DarkBlue" FontSize="10" TextWrapping="Wrap"/>
            </StackPanel>

                    <DataGrid Grid.Row="2" x:Name="FilesDataGrid" AutoGenerateColumns="False" 
                              CanUserAddRows="False" CanUserDeleteRows="False" 
                              SelectionMode="Single" Margin="0,10,0,0">
                        <DataGrid.Columns>
                            <DataGridTextColumn Header="File Name" Binding="{Binding FileName}" Width="250"/>
                            <DataGridTextColumn Header="File Path" Binding="{Binding FilePath}" Width="400"/>
                            <DataGridTextColumn Header="Tags" Binding="{Binding TagsString}" Width="200"/>
                            <DataGridTextColumn Header="Last Modified" Binding="{Binding LastModified, StringFormat={}{0:yyyy-MM-dd HH:mm}}" Width="150"/>
                        </DataGrid.Columns>
                        <DataGrid.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="Open File" Click="OpenFile_Click"/>
                                <MenuItem Header="Open File Location" Click="OpenFileLocation_Click"/>
                                <MenuItem Header="Manage Tags" Click="ManageFileTags_Click"/>
                            </ContextMenu>
                        </DataGrid.ContextMenu>
                    </DataGrid>
                </Grid>
            </TabItem>
        </TabControl>
    </Grid>
</Window>
